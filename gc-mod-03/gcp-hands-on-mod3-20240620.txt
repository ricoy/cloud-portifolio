# M√≥dulo 3 **| Implementa√ß√£o do Projeto Hands on - Solu√ß√£o**

### Aten√ß√£o!!!

### Essa documenta√ß√£o √© constantemente revisada e atualizada conforme mudan√ßas que ocorrem a todo momento nos provedores de cloud, que consequentemente afetam nossos hands-ons, e, em muitos casos, apenas alguns comandos s√£o necess√°rios atualiza√ß√£o/adi√ß√£o. Sendo assim, √© crucial e obrigat√≥rio, durante a implementa√ß√£o dos projetos, o acompanhamento com a ‚ÄòDocumenta√ß√£o de Solu√ß√£o‚Äô que cont√©m os passos e os comandos necess√°rios, e atualizados!

Parte 01: **Criar e Configurar Credenciais para o Terraform**

Parte 02: **Criar ‚ÄòSSH Keys‚Äô, Executar Terraform e Testar Conex√£o**

### Pr√©-requisito

- Cria√ß√£o de Conta AWS

## Parte 01 - Criar e Configurar Credenciais para o Terraform

### Cria√ß√£o Projeto na GCP

- Nome: `tcb-gcp-aws`

Valide que o novo projeto esteja associado √† uma Conta de Faturamento (Billing)

- Billing | Billing Management | Account Management
- Projects linked to this billing account

### Habilitar API Compute Engine e **Network Management API**

- APIs & Services | Enable APIs & service
    - Compute Engine API            - Cria√ß√£o de Compute Engine
    - Network Management API   - Teste de Conectidade

### **GCP - Cloud Shell**

- Short key: `g`+ `s`

### Limpando o Cloud Shell

```bash
Verifique se h√° arquivos pessoais no diret√≥rio principal:
**ls -a $HOME**

Removendo todos os arquivos:
**sudo rm -rf $HOME**

No menu do Cloud Shell, '...', clique em 'Reiniciar'.

Isso provisiona uma nova VM e restaura o diret√≥rio principal para o estado padr√£o.
Em alguns caso, feche o Cloud Shell e inicie uma nova sess√£o!
```

Se necess√°rio, configure o projeto (id) na sess√£o do Cloud Shell

```bash
**gcloud config set project PROJECT_ID

env
env | grep PROJECT
echo $DEVSHELL_PROJECT_ID**
```

- **Download / Unzip Arquivos do Projeto:**

```bash
**curl -O https://storage.googleapis.com/bootcamp-gcp-public/hands-on-tcb-bmc-gcp.zip
unzip hands-on-tcb-bmc-gcp.zip**
```

- **Adicionar Permiss√£o de Execu√ß√£o nos Arquivos (.sh):**

```bash
**cd hands-on-tcb-bmc-gcp
ls -la
chmod +x *.sh
ls -la**
```

### Cria√ß√£o Credenciais para o Terraform na GCP

Terraform necessita da credenciais para criar recursos nas Clouds.

**Cria√ß√£o de uma Key JSON da Service Account (SA) Default Compute Engine**

> Service Account Compute Engine Default √© uma conta de servi√ßo que √© automaticamente atribu√≠da a todas as inst√¢ncias do Google Compute Engine (GCE) quando elas s√£o criadas, a menos que uma conta de servi√ßo diferente seja especificada explicitamente durante a cria√ß√£o da inst√¢ncia. Essa conta de servi√ßo √© usada para autenticar a inst√¢ncia do GCE com outros servi√ßos da GCP. √â uma pr√°tica recomendada usar contas de servi√ßo com permiss√µes m√≠nimas necess√°rias para reduzir o risco de seguran√ßa.
> 

- IAM & Admin | Service Accounts
- Selecione: `xxxxxxxxxxx-compute@developer.gserviceaccount.com`
    - Name: `Compute Engine default service account`
- KEYS | ADD KEY | Create new key
- Key type: `JSON`

*Create* 

Sugest√£o: criar uma pasta `C:\GCP\Mod 03` para salvar os arquivos do m√≥dulo.

### Configurar as Credenciais da GCP

- Upload da Key JSON para o Cloud Shell.

```bash
**ls -l
ls -l ~

Sintaxe
./gcp_set_credentials.sh ~/file.json**
```

Resultado esperado:

```bash
Created /home/**your-gcp-user**/.config/gcloud/credentials_multiclouddeploy.json from /home/**your-gcp-user**/**your-sa-key.json**.
Updated gcp_credentials_file_path in /home/**your-gcp-user**/**your-gcp-project-id**/terraform/terraform.tfvars.
```

Valide que o caminho do arquivo da KEY JSON foi devidamente configurado:

```bash
cat /home/**your-gcp-user**/**your-gcp-project-id**/terraform/terraform.tfvars

cat /home/**your-gcp-user**/.config/gcloud/credentials_multiclouddeploy.json
```

![aws-transparent-icon.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/0d1b678b-cd91-4256-93c7-73b2e82396d5/fc59bbb5-e851-4a2a-9232-922127dac193/aws-transparent-icon.png)

### **Selecione a Regi√£o de Oregon (us-west-2)**

- Region: `Oregon`

Por que selecionar a Regi√£o Oregon?

aws_variable.tf

```bash
variable "aws_region" {
  description = "Default to Oregon region."
  default     = "us-west-2"
}
```

### Cria√ß√£o de Usu√°rio Program√°tico

Finalidade: acesso via linha de comandos para intera√ß√£o com recursos da AWS!

```
- IAM, Users, Create user
- User name: tcb-aws-gcp-automation

- [ ] Provide user access to the AWS Management Console - optional

Next

- Permissions options
- Attach policies directly: **AdministratorAccess**

Next
Create user
```

## Cria√ß√£o das Access Keys do Usu√°rio Program√°tico:

```
- Acesse o usu√°rio criado: tcb-aws-gcp-automation
- Security credentials
- Access keys, Create access key
- Use case: (*) Command Line Interface (CLI)
- [‚úî] I understand the above recommendation and want to proceed to create an access key.

Next
Create access key

* Access key: *****
* Secret access key: *****

- **Download .csv file

	REQUIREMENT: The access key file name must be 'accessKeys.csv'**

- Done

TIP: You can deactive/delete or create new one!
```

Abra o arquivo ‚ÄòaccessKeys.csv‚Äô e veja seu conte√∫do!

### Configurar as Credenciais da AWS

- Upload do arquivo ‚ÄòaccessKeys.csv‚Äô para o Cloud Shell.

```bash
**ls -l
ls -l ~
./aws_set_credentials.sh ~/accessKeys.csv**
```

Resultado esperado:

```bash
Created backup (/home/**your-gcp-user**/.aws/credentials_multiclouddeploy.bak).
Created /home/**your-gcp-user**/.aws/credentials_multiclouddeploy.
Updated aws_credentials_file_path in /home/**your-gcp-user**/**your-gcp-project-id**/terraform/terraform.tfvars.
```

Valide que o caminho do arquivo da KEY JSON foi devidamente configurado:

```bash
cat /home/**your-gcp-user**/**your-gcp-project-id**/terraform/terraform.tfvars

cat /home/**your-gcp-user**/.aws/credentials_multiclouddeploy
```

### Download Terraform

```bash
**ls ~/terraform**            No such file or directory

**./get_terraform.sh**

**ls ~/terraform**
```

### Configurar o Projeto GCP no Arquivos de Configura√ß√£o do Terraform

```bash
# make sure you're in the correct GCP project
**gcloud config set project PROJECT_ID**

	**./gcp_set_project.sh**
```

Resultado esperado:

```bash
Updated gcp_project_id in /home/**your-gcp-user**/**your-gcp-project-id**/terraform/terraform.tfvars
```

Valide que o caminho do arquivo da KEY JSON foi devidamente configurado:

```bash
cat /home/**your-gcp-user**/**your-gcp-project-id**/terraform/terraform.tfvars

```

Fim da Parte 01.

## Parte 02 - Criar ‚ÄòSSH Keys‚Äô, Executar Terraform e Teste Conex√£o

### Cria√ß√£o de um Par de Chaves SSH

Necess√°rio para cria√ß√£o e acesso √† VMs que ser√£o criadas no processo.

**Cloud Shell**

```bash
# Getting your username
**whoami**

# Generating a SSH Key Pairs (Public and Private)
**ls -la ~**
**ssh-keygen -t rsa -f ~/.ssh/vm-ssh-key -C YOUR-USERNAME**

**Your identification has been saved in /home/your-username/.ssh/vm-ssh-key
Your public key has been saved in /home/your-username/.ssh/vm-ssh-key.pub

ls -la ~**

# Changing SSH Key Permissions
**ls -la ~/.ssh/vm-ssh-key
chmod 400 ~/.ssh/vm-ssh-key
ls -la ~/.ssh/vm-ssh-key**
```

## Importar Chave P√∫blica para GCP

- Compute Engine | Settings | Metadata | SSH KEYS

```bash
**gcloud compute config-ssh --ssh-key-file=~/.ssh/vm-ssh-key**
```

Resultado esperado:

```bash
Updating project ssh metadata...working.Updated [https://www.googleapis.com/compute/v1/projects/cd-k8s-gcp].                                  
Updating project ssh metadata...done.                                                                                                         
WARNING: No host aliases were added to your SSH configs because you do not have any running instances. 
```

Valide a importa√ß√£o da chave:

- Compute Engine | Settings | Metadata | SSH KEYS

Em alguns casos, o terminal solicita realizar um processo de autentica√ß√£o.

Se, for o caso, o comando abaixo deve ser executado:

```bash
**gcloud auth login**
```

![aws-transparent-icon.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/0d1b678b-cd91-4256-93c7-73b2e82396d5/fc59bbb5-e851-4a2a-9232-922127dac193/aws-transparent-icon.png)

### Importar Chave P√∫blica para AWS

Download do arquivo da chave

```bash
PATH:
**/home/[YOUR-USERNAME]/.ssh/vm-ssh-key.pub

Example:
/home/tcbchallengeday/.ssh/vm-ssh-key.pub**
```

AWS | EC2 Dashboard | Network & Security | Key Pairs

- Actions:¬†`Import Key Pair`
- Name: `vm-ssh-key`
- Browse: `vm-ssh-key-pub`

Import key pair

### Executando Terraform

```bash
Make sure to be inside of `hands-on-tcb-bmc-gcp` directory!

cd terraform
```

Antes de executarmos o Terraform, vamos analisar o arquivo `main.tf`!

```bash
# Initialize the directory with Terraform files and install the providers/plugins.
terraform init

# It checks the syntax/configuration of your Terraform files.
terraform validate

# Review the infrastructure changes desired: create, modify or destroy
terraform plan

Plan: 41 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + aws_instance_external_ip = (known after apply)
  + aws_instance_internal_ip = "172.16.0.100"
  + gcp_instance_external_ip = (known after apply)
  + gcp_instance_internal_ip = "10.88.0.100"

# Apply the changes planning: create, modify or destroy
terraform apply

# It displays the outputs (resources properties) defined in your configuration files.
terraform output
```

### Validando a Cria√ß√£o dos Recursos

- **VPC** (AWS  e GCP)
- **EC2** (AWS) / GCE (GCP)
- AWS - VPC / VPN
    - **Virtual private gateways**
    - **Customer Gateways (AWS)**
- GCP - Network Connectivity
    - **VPN (Cloud VPN Tunnels/Gateways)**
    - **Cloud Routers**

### Teste de Conectividade: Ping

- GCP | GCE: SSH na VM `tcb-gcp-vm-01`

```bash
**ip a**
inet 10.88.0.100/32

ping 172.16.0.100  [private ip of AWS EC2 instance]

ping 172.16.0.100 c4

64 bytes from 172.16.0.100: icmp_seq=1 ttl=63 time=19.5 ms
64 bytes from 172.16.0.100: icmp_seq=2 ttl=63 time=17.3 ms
64 bytes from 172.16.0.100: icmp_seq=3 ttl=63 time=17.2 ms
64 bytes from 172.16.0.100: icmp_seq=4 ttl=63 time=17.4 ms

A avalia√ß√£o da lat√™ncia √© feita pelos valores de tempo (`time`) 
apresentados ap√≥s cada sequ√™ncia de ping. 
No resultado acima, a lat√™ncia m√©dia √© de aproximadamente 17,85 milissegundos (ms). 

Este valor representa o tempo que os pacotes ICMP levou para ir da GCP/GCE,
para o endere√ßo IP 172.16.0.100 (AWS/EC2) e voltar.

Quanto menor o valor, melhor √© a lat√™ncia da conex√£o. 

Em geral, lat√™ncias abaixo de 100 ms s√£o consideradas boas para a maioria das aplica√ß√µes.
```

### Teste de Conectividade: Connectivity Tests

Network Intelligence | Connectivity Tests

- Test name: `tcb-aws-gcp`
- Source: `vm-instance` | `tcb-gcp-vm01`
- Destination: `172.16.0.100`

Create

View

## Evid√™ncia

- Resultado do Teste de Conectividade

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/0d1b678b-cd91-4256-93c7-73b2e82396d5/c6ac2723-5396-40c9-b78f-12b3fe39aa09/Untitled.png)

### Exclus√£o dos Recursos

```bash
**terraform destroy**

Destroy complete! Resources: 41 destroyed.
```

***TCB*** üöÄ