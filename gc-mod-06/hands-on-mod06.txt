# MÃ³dulo 6 **| ImplementaÃ§Ã£o do Projeto Hands on - SoluÃ§Ã£o**

### AtenÃ§Ã£o!!!

### Essa documentaÃ§Ã£o Ã© constantemente revisada e atualizada conforme mudanÃ§as que ocorrem a todo momento nos provedores de cloud, que consequentemente afetam nossos hands-ons, e, em muitos casos, apenas alguns comandos sÃ£o necessÃ¡rios atualizaÃ§Ã£o/adiÃ§Ã£o. Sendo assim, Ã© crucial e obrigatÃ³rio, durante a implementaÃ§Ã£o dos projetos, o acompanhamento com a â€˜DocumentaÃ§Ã£o de SoluÃ§Ã£oâ€™ que contÃ©m os passos e os comandos necessÃ¡rios, e atualizados!

Parte 01: **Deploy da AplicaÃ§Ã£o KidsFlix na FinlÃ¢ndia e USA.**

Parte 02: **Deploy de um Load Balancing Global.**

### CriaÃ§Ã£o de um Projeto (Opcional)

- Nome: `tcb-mod6`

### HabilitaÃ§Ã£o das APIs

- APIs & Services | Enable APIs & service
    - **`Compute Engine API`**
    - **`Artifact Registry API`**
    - **`Cloud Build API`**
    - **`Cloud Run Admin API`**

- **Validando as APIs habilitadas:**
    - IAM | Asset Inventory | Resource | serviceusage.Service
    - `gcloud services list`
    

Docker Process

[Layers | Docker Docs](https://docs.docker.com/build/guide/layers/)

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/0d1b678b-cd91-4256-93c7-73b2e82396d5/757b22b8-3ff4-4d70-8686-2a839e2907b0/Untitled.png)

# Parte 1 - Deploy da AplicaÃ§Ã£o: FinlÃ¢ndia e USA

### ğŸ‡«ğŸ‡® App Kids Flix na FinlÃ¢ndia

```yaml
**wget https://storage.googleapis.com/bootcamp-gcp-en/bootcamp-gcp-module-lb-files-app-finland.zip
unzip bootcamp-gcp-module-lb-files-app-finland.zip
cd ~/bootcamp-gcp-module-lb-files-app-finland**

# CriaÃ§Ã£o do RepositÃ³rio 'finland-repo' no Artifcat Registry
**gcloud artifacts repositories create finland-repo --repository-format=docker \
--location=europe-north1 --description="Docker repository"**

# Build do container image utilizando o Cloud Build
**gcloud builds submit --tag \
"europe-north1-docker.pkg.dev/$DEVSHELL_PROJECT_ID/finland-repo/appkidsflixfinland"**

# Deploy no Cloud Run
**gcloud run deploy --image \
"europe-north1-docker.pkg.dev/$DEVSHELL_PROJECT_ID/finland-repo/appkidsflixfinland" \
--port=5000 --platform=managed**

Press **Enter** to confirm the default application name: **appkidsflixfinland**
Select the number of the region '**europe-north1**' typing the number: **14** 

		AtenÃ§Ã£o: Certifique-se de selecionar o nÃºmero ref. Ã  regiÃ£o: **europe-north1**

Allow unauthenticated requests by typing:  **y**
```

### ğŸ‡ºğŸ‡¸ App Kids Flix USA

```yaml
**cd
wget https://storage.googleapis.com/bootcamp-gcp-en/bootcamp-gcp-module-lb-files-app-usa.zip
unzip bootcamp-gcp-module-lb-files-app-usa.zip
cd ~/bootcamp-gcp-module-lb-files-app-usa**

# CriaÃ§Ã£o do RepositÃ³rio 'usa-repo' no Artifcat Registry
**gcloud artifacts repositories create usa-repo --repository-format=docker \
--location=us-central1 --description="Docker repository"**

# Build do container image utilizando o Cloud Build
**gcloud builds submit --tag \
"us-central1-docker.pkg.dev/$DEVSHELL_PROJECT_ID/usa-repo/appkidsflixusa"**

# Deploy no Cloud Run
**gcloud run deploy --image \
"us-central1-docker.pkg.dev/$DEVSHELL_PROJECT_ID/usa-repo/appkidsflixusa" \
--port=5000 --platform=managed**

Press **Enter** to confirm the default application name: **appkidsflixusa**
Select the region, '**us-central1**', typing the number: **32** 

		AtenÃ§Ã£o: Certifique-se de selecionar o nÃºmero ref. Ã  regiÃ£o: **us-central1**

Allow unauthenticated requests by typing:  **y**
```

# Parte 2 - Deploy de um Load Balancing Global

- **CriaÃ§Ã£o de 02 serverless Network Endpoint Groups (NEG)**

```yaml
**gcloud compute network-endpoint-groups create sneg-appkidsflixfinland \
--region=europe-north1 --network-endpoint-type=serverless \
--cloud-run-service=appkidsflixfinland

gcloud compute network-endpoint-groups create sneg-appkidsflixusa \
--region=us-central1 --network-endpoint-type=serverless \
--cloud-run-service=appkidsflixusa**
```

> Os Network Endpoint Groups (NEG) sÃ£o objetos que especificam grupos de extremidades (endpoints) de rede para serviÃ§os que sÃ£o acessados por LB do GCP.
> 

> Os NEG baseados em serviÃ§o, sÃ£o usados para especificar grupos de Compute Engine, Google Kubernetes Engine (GKE) ou **Cloud Run**. Eles sÃ£o Ãºteis quando vocÃª deseja direcionar o trÃ¡fego para serviÃ§os executados em instÃ¢ncias gerenciadas pelo Google Cloud.
> 

- **CriaÃ§Ã£o do ServiÃ§o de Backend Global**

```yaml
**gcloud compute backend-services create kidsflix-backend-global --global**
```

- **ConfiguraÃ§Ã£o dos â€˜NEGâ€™ no ServiÃ§o de Backend Global**

```yaml
**gcloud compute backend-services add-backend kidsflix-backend-global \
--global --network-endpoint-group=sneg-appkidsflixfinland \
--network-endpoint-group-region=europe-north1

gcloud compute backend-services add-backend kidsflix-backend-global \
--global --network-endpoint-group=sneg-appkidsflixusa \
--network-endpoint-group-region=us-central1**
```

- **CriaÃ§Ã£o de uma URL MAP para direcionar as requisiÃ§Ãµes de entrada para o Backend**

```yaml
**gcloud compute url-maps create lb-kidsflix-global \
--default-service kidsflix-backend-global**
```

> URL Map Ã© usado para direcionar o trÃ¡fego de entrada para os serviÃ§os corretos com base nas regras de encaminhamento definidas.
> 

- **CriaÃ§Ã£o do Target HTTP(S) Proxy para direcionar as requisiÃ§Ãµes para a URL MAP**

```yaml
**gcloud compute target-http-proxies create lb-kidsflix-httpproxy \
--url-map=lb-kidsflix-global**
```

[Target proxies overview Â |Â  Load Balancing Â |Â  Google Cloud](https://cloud.google.com/load-balancing/docs/target-proxies)

> Um proxy HTTP de destino Ã© usado para rotear o trÃ¡fego HTTP de entrada para os servidores ou instÃ¢ncias de backend corretas. Ajuda no balanceamento de carga, roteamento de trÃ¡fego, e atÃ© mesmo para filtrar ou modificar solicitaÃ§Ãµes HTTP.
> 

*Proxy de destino melhora a capacidade de resposta e a confiabilidade do serviÃ§o!*

- **Reservar EndereÃ§o IP destinado para o External HTTP Load Balancer**

```yaml
**gcloud compute addresses create kidsflix-global-ip --ip-version=IPV4 --global**

# Verifique o IP reservado para o kidsflix-global-ip
**gcloud compute addresses describe kidsflix-global-ip --format="get(address)" --global**
```

- **CriaÃ§Ã£o de Regra de Encaminhamento Global - RequisiÃ§Ãµes de Entrada >> Proxy (Frontend)**

```yaml
gcloud compute forwarding-rules create kidsflix-frontend-global \
--address=kidsflix-global-ip --target-http-proxy=lb-kidsflix-httpproxy \
--global --ports=80
```

- ConfiguraÃ§Ã£o Regra de Firewall - Acesso Ã  Porta 80 (HTTP)
    - Firewal Rule Name: `allow-app-port-80`

Para realizar os testes de acesso Ã  aplicaÃ§Ã£o e validar o direcionamento inteligente com base na localizaÃ§Ã£o, instale a seguinte extensÃ£o no seu navegador Chrome/Edge:

- Nome ExtensÃ£o:Â `VPN Proxy VeePN`
- Microsoft Edge: [Free VPN for Edge - VPN Proxy VeePN - Microsoft Edge Addons](https://microsoftedge.microsoft.com/addons/detail/free-vpn-for-edge-vpn-p/panammoooggmlehahpcjckcncfeffcoi)
- ApÃ³s instalaÃ§Ã£o, acesse a extensÃ£o e ative a VPN.

- Para os testes da aplicaÃ§Ã£oÂ **KidsFlix nos EUA**, vocÃª pode selecionarÂ **Oregon**
- Para os testes da aplicaÃ§Ã£oÂ **KidsFlix na FinlÃ¢ndia**, vocÃª pode selecionarÂ **FranÃ§a**.