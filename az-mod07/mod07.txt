MÃ³dulo 7 | ImplementaÃ§Ã£o do Projeto Hands on - SoluÃ§Ã£o
AtenÃ§Ã£o!!! 
Essa documentaÃ§Ã£o Ã© constantemente revisada e atualizada conforme mudanÃ§as que ocorrem a todo momento nos provedores de cloud, que consequentemente afetam nossos hands-ons, e, em muitos casos, apenas alguns comandos sÃ£o necessÃ¡rios atualizaÃ§Ã£o/adiÃ§Ã£o. Sendo assim, Ã© crucial e obrigatÃ³rio, durante a implementaÃ§Ã£o dos projetos, o acompanhamento com a â€˜DocumentaÃ§Ã£o de SoluÃ§Ã£oâ€™ que contÃ©m os passos e os comandos necessÃ¡rios, e atualizados! 
ImplementaÃ§Ã£o de uma Arquitetura Serverless para um website em vÃ¡rios ambientes (teste/QA/produÃ§Ã£o), Totalmente Automatizada, utilizando Azure DevOps Repos & Pipelines (CI/CD).
PrÃ©-requisito: 
CriaÃ§Ã£o Azure DevOps OrganizaÃ§Ã£o;
CriaÃ§Ã£o Projeto na Azure DevOps OrganizaÃ§Ã£o;
SolicitaÃ§Ã£o do Azure DevOps Parallelism.
Parte 01: CriaÃ§Ã£o e ConfiguraÃ§Ã£o das Storage Accounts para cada ambiente: Teste, QA, ProduÃ§Ã£o
Parte 02: CriaÃ§Ã£o das Pipelines CI/CD
Parte 03: Testar e Validar as Pipelines
Parte 01 - CriaÃ§Ã£o e ConfiguraÃ§Ã£o das Storage Accounts
CriaÃ§Ã£o de uma Storage Account para cada ambiente: test, QA e prod
Resource Group: tcb-devops
Region: East US
test: tcbmod7test
QA: tcbmod7qa
prod: tcbmod7prod
Habilitar Static Website e Configurar index.html como Home Page
Antes, valide o conteÃºdo atual dos containers das storage accounts! 
Data Storage | Containers
Data Management | Static Website | Enabled
Index document name: index.html
Save and Copy â€˜Primary endpointâ€™

test: https://tcbmod7test.z13.web.core.windows.net/
	QA: https://tcbmod7qa.z13.web.core.windows.net/
prod: https://tcbmod7prod.z13.web.core.windows.net/

â€‹
Azure DevOps Organizations
Habilitar â€œClassic Build and Release Pipelinesâ€
Acesse sua organizaÃ§Ã£o
Organization settings
Pipelines | Settings | General

Acesse o Projeto Criado: website01
Gerar Credenciais para Processo de Push no Azure Repos
Repos | Generate Git Credentials
uhtvfo5sdt7sj7tox5ktkff5j6dcjgxbhixkmayu42mc7ywslpaa
â€‹
Download Website Files
Cloud Shell
curl -O https://tcb-bootcamps.s3.amazonaws.com/bootcamp-microsoft-azure/en/mod7-azuredevops.zip
unzip mod7-azuredevops.zip
cd azuredevops
â€‹
Pushing Website Files to Azure Repos
Cloud Shell
# Copy these commands from Repos: "Push an existing repository from command line"

git remote add origin https://tcb-mod7@dev.azure.com/tcb-mod7/website01/_git/website01

error: git remote origin already exists.
Solution: 
git remote remove origin

git push -u origin --all
â€‹
Valide os arquivos no Azure Repos: Repos | Files
Fim da Parte 01.
Parte 02 - CriaÃ§Ã£o das Pipelines CI/CD
CriaÃ§Ã£o Pipeline - CI (ContÃ­nuos Integration)
Pipelines | Pipelines | Create Pipeline
Use the classic editor to create a pipeline without YAML.
Select a source: Azure Repos Git
Continue / Empty Job
Adicionando as Tarefas (Jobs) da Pipeline CI
Task: Zipping Files
Name: website01-CI
Agent Job 1 +
Search for: Archive files Add
Selecione a tarefa adicionada e altere o â€˜Display nameâ€™
Display name: Zip files
Root folder or file to archive: ... selectfiles folder
Task: Publishing Files
Agent Job 1 +
Search for: Publish build artifacts Add
Selecione a tarefa adicionada e altere o â€˜Display nameâ€™
Display name: Artifacts Publish
 ðŸ”½ Save (Do not Click on â€œSave & Queueâ€)
Save
Trigger
[ â˜‘ï¸ ] Enable continuous integration
 ðŸ”½ Save (Do not Click on â€œSave & Queue)
Save
CriaÃ§Ã£o Pipeline - CD (ContÃ­nuos Deployment)
Pipelines | Releases | New pipeline
Empty job
Rename from â€˜New release pipelineâ€™ to website01-CD
+ Add an artifact
Build
Project: website01
Source (build pipeline): website01-CI
Add
âš¡ Continuous deployment trigger
[ â˜‘ï¸ ] Enabled
Creates a release every time a new build is available
Adicionando as â€˜Stagesâ€™ da Pipeline CD
Stage: Test 
Stage 1 >> Stage name: Test 
Task: Extracting Files
1 job, 0 task
Agent Job +
Search for: Extract files Add
Selecione a tarefa adicionada e altere o â€˜Display nameâ€™
Display name: Extract files
Archive file patterns: **/$(Build.BuildId).zip
Destination folder: $(Build.DefaultWorkingDirectory)/$(Build.BuildId)
Task: Upload files to Azure Blob with Azure CLI
Agent Job +
Search for: Azure CLI Add
Selecione a tarefa adicionada e altere o â€˜Display nameâ€™
Display name: Upload files to Azure Blob
Azure Resource Manager connection: Azure Subscription | Authorize
Talvez seja solicitado fazer login na Azure
Script Type: Shell
Script location: Inline script
az storage blob upload-batch --account-name <YOUR-STORAGE-ACCOUNT_NAME-TEST-ENV> --destination "\$web" --source ./files --overwrite
â€‹
\$web Ã© uma convenÃ§Ã£o usada no Azure Blob Storage para indicar o contÃªiner que hospeda conteÃºdo web estÃ¡tico.
Working Directory: $(Build.DefaultWorkingDirectory)/$(Build.BuildId)
Save / OK
Stage: QA 
Vamos â€˜clonarâ€™ o stage â€˜Test!
Stage Test | Clone | Clone of Test >> QA
1 job, 2 task
Task Upload files to Azure Blob
az storage blob upload-batch --account-name <YOUR-STORAGE-ACCOUNT_NAME-QA-ENV> --destination "\$web" --source ./files --overwrite
â€‹
Save / OK
Stage: Prod 
Vamos â€˜clonarâ€™ o stage â€˜QAâ€™!
Stage Test | Clone | Clone of Test >> Prod
1 job, 2 task
Task Upload files to Azure Blob
az storage blob upload-batch --account-name <YOUR-STORAGE-ACCOUNT_NAME-PROD-ENV> --destination "\$web" --source ./files --overwrite
â€‹
Save / OK
Habilitar AprovaÃ§Ã£o para Deploy em Ambiente Produtivo
Click on Pipeline
From the Prodstage, Enable  to get approval before deploying to production.
âš¡ Pre-deployment conditions
[ â˜‘ï¸ ] Enabled
Approvers: search for your azure user/email address
Save / Ok
Fim da Parte 02.
Parte 03 - Testar e Validar as Pipelines
Executando a Pipeline - CI (ContÃ­nuos Integration)
Pipelines | Pipelines | website01-CI
Run pipeline 
Run
Acompanhe os logs / Monitore a Pipeline
Click on Agent job 1
VocÃª pode obter alguma mensagem sobre indisponibilidade dos agentes para executar a pipeline.
Acquiring an agent from the cloud:
This agent cloud does not support more specific status information.
â€‹
VocÃª pode tentar com outros agentes: Windows 2019, Windows 2022, Windows Latest!
TambÃ©m Ã© possÃ­vel que em algum â€œstageâ€ o agent nÃ£o inicie o processo, vocÃª pode cancelar e re-executar!
Ao final do processo da execuÃ§Ã£o da Pipeline-CI, uma â€˜releaseâ€™ serÃ¡ criada, dando inÃ­cio a execuÃ§Ã£o da Pipeline-CD.
Stage: Prod
Necessita AprovaÃ§Ã£o!
Valide as URLs das Storage Accounts | Static Website
Alterando o Website
Cloud Shell
cd azuredevops/
vi files/index.html

# Press: 'Insert' Key
# Line 33: Congratulations >> Good Job
# Press: 'Esc' Key
# Type: ':x'
# Press: 'Enter' Key

cat files/index.html | grep -i Good

git add files/index.html

git config --global user.name "Your Name"
git config --global user.email "Your Azure Email Account" 

git commit -m "changing index.html"
git push -u origin --all

Repos | Credentials